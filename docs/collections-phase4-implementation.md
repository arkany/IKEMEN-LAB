# Collections Phase 4 Implementation Guide

## Overview

This document describes the implementation of **Phase 4: Activate Collection** for the IKEMEN Lab Collections system. Phase 4 adds the ability to activate a collection, which generates and writes a `select.def` file that IKEMEN GO reads at launch.

## What Was Implemented

### Core Models and Services

#### 1. `Collection.swift` (`IKEMEN Lab/Models/`)
- **Purpose**: Data model for collections
- **Key Properties**:
  - `isActive: Bool` - Tracks if this collection is currently active
  - `characters: [RosterEntry]` - Ordered list of roster entries
  - `stages: [String]` - Stage folder names
  - `screenpackPath: String?` - Optional screenpack reference
  - `isDefault: Bool` - True for "All Characters" collection

- **RosterEntry Types**:
  - `.character` - Regular character reference
  - `.randomSelect` - "randomselect" placeholder
  - `.emptySlot` - Empty line for grid spacing

#### 2. `CollectionStore.swift` (`IKEMEN Lab/Core/`)
- **Purpose**: Manages collection persistence and state
- **Storage Location**: `~/Library/Application Support/IKEMEN Lab/collections/*.json`
- **Key Methods**:
  - `setActive(_:)` - Marks a collection as active, posts notification
  - `syncDefaultCollectionWithCharacters(_:)` - Updates default collection with library contents
  - `collection(withId:)` - Retrieve specific collection
  - `activeCollection` - Get currently active collection

#### 3. `SelectDefGenerator.swift` (`IKEMEN Lab/Core/`)
- **Purpose**: Generates select.def content from Collection
- **Key Features**:
  - Creates timestamped backups: `select.def.backup.YYYYMMDD-HHMMSS`
  - Validates character paths exist before generation
  - Handles `randomselect` and empty slots
  - Auto-detects .def files when not specified

- **Key Methods**:
  - `generate(from:ikemenPath:)` - Creates select.def content
  - `writeSelectDef(for:ikemenPath:)` - Writes with backup
  - `validateCollection(_:ikemenPath:)` - Returns list of missing characters

#### 4. `CollectionEditorView.swift` (`IKEMEN Lab/UI/`)
- **Purpose**: UI for editing and activating collections
- **Key Features**:
  - Displays collection name and character count
  - "Activate" button that triggers activation
  - Validation warning for missing characters
  - Button disabled when collection is already active
  - Styled with DesignColors/DesignFonts

#### 5. `EmulatorBridge.swift` Integration
- **Changes Made**:
  - Added `setupCollectionObserver()` in initialization
  - Added `handleCollectionActivated(_:)` notification handler
  - Calls `SelectDefGenerator.writeSelectDef()` when collection activated
  - Shows success/error toasts via `ToastManager.shared`
  - Syncs default collection when characters load

## How It Works

### Activation Flow

```
1. User clicks "Activate" button in CollectionEditorView
   ↓
2. CollectionEditorView validates collection
   - Calls SelectDefGenerator.validateCollection()
   - Shows warning if characters are missing
   - User confirms or cancels
   ↓
3. CollectionEditorView calls onActivate callback
   ↓
4. CollectionStore.setActive() is called
   - Updates all collections' isActive property
   - Saves activeCollectionId to UserDefaults
   - Posts .collectionActivated notification
   ↓
5. EmulatorBridge receives notification
   ↓
6. SelectDefGenerator.writeSelectDef() is called
   - Creates backup: data/select.def.backup.{timestamp}
   - Generates new select.def content
   - Writes to data/select.def
   ↓
7. Toast notification shows success or error
```

### select.def Generation

Example output for a collection with 3 characters, 1 randomselect, 1 empty slot, and 2 stages:

```ini
; Generated by IKEMEN Lab
; Collection: Marvel vs Capcom
; Generated: 2026-01-09T12:34:56Z
; DO NOT EDIT - This file is managed by IKEMEN Lab

[Characters]
Ryu/Ryu.def
Ken/Ken.def
Chun-Li/Chun-Li.def
randomselect

Cyclops/Cyclops.def

[ExtraStages]
stages/Bifrost/Bifrost.def
stages/Training/Training.def

[Options]
arcade.maxmatches = 6,1,1,0,0,0,0,0,0,0
team.maxmatches = 4,1,1,0,0,0,0,0,0,0
```

## Integration with Existing Code

### To Wire Up CollectionEditorView in GameWindowController

The `CollectionEditorView` is ready to use but needs to be integrated into the main window. Here's how:

```swift
// In GameWindowController.swift

// 1. Add property for collection editor view
private var collectionEditorView: CollectionEditorView?

// 2. In setupMainArea() or similar, create the view when needed
func showCollectionEditor(for collection: Collection) {
    // Hide other views
    dashboardView?.isHidden = true
    characterBrowserView?.isHidden = true
    // ... etc
    
    // Create or update collection editor
    if collectionEditorView == nil {
        collectionEditorView = CollectionEditorView(collection: collection)
        collectionEditorView?.translatesAutoresizingMaskIntoConstraints = false
        collectionEditorView?.onActivate = { [weak self] collection in
            self?.activateCollection(collection)
        }
        mainAreaView.addSubview(collectionEditorView!)
        
        NSLayoutConstraint.activate([
            collectionEditorView!.topAnchor.constraint(equalTo: mainAreaView.topAnchor),
            collectionEditorView!.leadingAnchor.constraint(equalTo: mainAreaView.leadingAnchor),
            collectionEditorView!.trailingAnchor.constraint(equalTo: mainAreaView.trailingAnchor),
            collectionEditorView!.bottomAnchor.constraint(equalTo: mainAreaView.bottomAnchor)
        ])
    } else {
        collectionEditorView?.updateCollection(collection)
    }
    
    collectionEditorView?.isHidden = false
}

// 3. Handle activation
func activateCollection(_ collection: Collection) {
    CollectionStore.shared.setActive(collection)
    
    // Update UI to show collection is now active
    collectionEditorView?.updateCollection(collection)
}
```

### To Add Collections Sidebar Section

To add a collections section to the sidebar (as shown in the spec), you would:

1. Add a new section header between LIBRARY and bottom items
2. List all collections with status indicators
3. Add click handler to show CollectionEditorView
4. Show green dot (●) for active collection

Example additions to `setupSidebar()`:

```swift
// After LIBRARY section nav items...

// === COLLECTIONS Section ===
let collectionsHeader = NSTextField(labelWithString: "COLLECTIONS")
collectionsHeader.font = DesignFonts.caption(size: 11)
collectionsHeader.textColor = DesignColors.textTertiary
navStack.addArrangedSubview(collectionsHeader)

// Subscribe to collection changes
CollectionStore.shared.$collections
    .sink { [weak self] collections in
        self?.updateCollectionsList(collections)
    }
    .store(in: &cancellables)
```

## Testing the Implementation

### Manual Testing Steps

1. **Create a Collection**:
   ```swift
   let collection = CollectionStore.shared.createCollection(name: "Test Collection")
   ```

2. **Add Characters**:
   ```swift
   CollectionStore.shared.addCharacter(folder: "Ryu", to: collection.id)
   CollectionStore.shared.addCharacter(folder: "Ken", to: collection.id)
   ```

3. **Activate Collection**:
   ```swift
   CollectionStore.shared.setActive(collection)
   ```

4. **Verify**:
   - Check `data/select.def` has been updated
   - Check backup exists: `data/select.def.backup.{timestamp}`
   - Check toast notification appeared
   - Check `collection.isActive == true`

### Test Cases

- ✅ Create collection
- ✅ Add/remove characters from collection
- ✅ Activate collection (generates select.def)
- ✅ Backup is created before overwriting
- ✅ Validation warns about missing characters
- ✅ Only one collection can be active at a time
- ✅ Default collection syncs with library
- ✅ Collections persist across app restarts
- ✅ Active collection persists across app restarts

## File Locations

| File | Purpose |
|------|---------|
| `IKEMEN Lab/Models/Collection.swift` | Data models |
| `IKEMEN Lab/Core/CollectionStore.swift` | Persistence & state |
| `IKEMEN Lab/Core/SelectDefGenerator.swift` | select.def generation |
| `IKEMEN Lab/UI/CollectionEditorView.swift` | Editor UI |
| `IKEMEN Lab/Core/EmulatorBridge.swift` | Integration (modified) |

## Safety Features

1. **Automatic Backups**: Every select.def write creates a timestamped backup
2. **Validation**: Warns if collection references characters not in library
3. **User Confirmation**: Requires confirmation when missing characters detected
4. **Atomic Writes**: Uses atomically:true to prevent corruption
5. **Error Handling**: Shows toast on failure with error details

## Known Limitations

- Sidebar integration not included (requires GameWindowController refactoring)
- Character/stage picker sheets not implemented (nice-to-have feature)
- No "green dot" indicator in sidebar yet (requires sidebar section)
- Collection editor view needs to be manually wired into navigation

## Next Steps

To complete full Collections feature:

1. **Phase 2**: Add collections section to sidebar
   - List all collections
   - Create/rename/delete UI
   - Click to open CollectionEditorView

2. **Phase 3**: Enhance CollectionEditorView
   - Add character picker sheet
   - Add stage picker sheet
   - Drag-to-reorder roster grid

3. **Polish**:
   - Add icons/badges for collection status
   - Screenpack selection
   - Export/import collections

## Code Example: Using Collections

```swift
import Foundation

// Create a new collection
let collection = CollectionStore.shared.createCollection(
    name: "Marvel vs Capcom",
    icon: "folder.fill"
)

// Add characters
CollectionStore.shared.addCharacter(folder: "Ryu", to: collection.id)
CollectionStore.shared.addCharacter(folder: "Wolverine", to: collection.id)
CollectionStore.shared.addRandomSelect(to: collection.id)
CollectionStore.shared.addEmptySlot(to: collection.id)

// Add stages
CollectionStore.shared.addStage(folder: "Bifrost", to: collection.id)
CollectionStore.shared.addStage(folder: "Training", to: collection.id)

// Activate (generates select.def)
CollectionStore.shared.setActive(collection)
// This posts .collectionActivated notification
// EmulatorBridge receives it and generates select.def
// Toast appears confirming success

// Check if collection is active
let isActive = collection.isActive  // true

// Get active collection
if let active = CollectionStore.shared.activeCollection {
    print("Active collection: \(active.name)")
}

// Access default collection
if let defaultCollection = CollectionStore.shared.collections.first(where: { $0.isDefault }) {
    print("Default collection has \(defaultCollection.characters.count) characters")
}
```

## Notification Pattern

The activation uses NotificationCenter:

```swift
// Notification is posted when collection is activated
extension Notification.Name {
    static let collectionActivated = Notification.Name("collectionActivated")
}

// EmulatorBridge listens for this notification
@objc private func handleCollectionActivated(_ notification: Notification) {
    guard let collection = notification.object as? Collection,
          let ikemenPath = self.engineWorkingDirectory else { return }
    
    let result = SelectDefGenerator.writeSelectDef(for: collection, ikemenPath: ikemenPath)
    
    switch result {
    case .success:
        ToastManager.shared.showSuccess(title: "Collection Activated")
    case .failure(let error):
        ToastManager.shared.showError(title: "Activation Failed", subtitle: error.localizedDescription)
    }
}
```

## Troubleshooting

### "IKEMEN GO installation not found"
- Ensure `IkemenBridge.shared.workingDirectory` is set
- Run First Run Experience if needed
- Check AppSettings.shared.ikemenGOPath

### select.def not being generated
- Check console for errors
- Verify notification is being posted
- Verify EmulatorBridge observer is set up
- Check file permissions on data/ directory

### Characters missing in game after activation
- Check select.def content is valid
- Verify character folders exist
- Check .def file names are correct
- Look for typos in folder names

### Collection not persisting
- Check `~/Library/Application Support/IKEMEN Lab/collections/` exists
- Verify JSON files are being written
- Check file permissions

## Summary

Phase 4 implementation provides a complete, working collection activation system with:

✅ Data persistence (JSON)  
✅ select.def generation with backup  
✅ Missing content validation  
✅ Toast notifications  
✅ Default collection auto-sync  
✅ Safe file operations  

The core functionality is production-ready. Full integration requires wiring up the UI components into GameWindowController's navigation system.
